<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Controle de Atendimentos - Secretaria</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: linear-gradient(135deg, #f5f7fa, #e4ecf7);
      min-height: 100vh;
    }

    .page-header {
      background: linear-gradient(135deg, #0d6efd, #6610f2);
      border-radius: 16px;
      padding: 20px 24px;
      color: #fff;
      box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    }

    .page-header h1 {
      font-size: 1.7rem;
      margin-bottom: 4px;
    }

    .page-header p {
      margin: 0;
      opacity: 0.9;
    }

    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.08);
    }

    .card-header {
      border-radius: 16px 16px 0 0 !important;
    }

    .table > :not(caption) > * > * {
      vertical-align: middle;
    }

    .table thead th {
      background-color: #f1f5f9;
      border-bottom-width: 1px;
    }

    /* Status em "p√≠lula" colorida */
    .status-pendente {
      font-weight: 600;
      color: #856404;
      background-color: #fff3cd;
      padding: 2px 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .status-pendente-atrasado {
      font-weight: 700;
      color: #842029;
      background-color: #f8d7da;
      padding: 2px 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .status-resolvido {
      font-weight: 600;
      color: #0f5132;
      background-color: #d1e7dd;
      padding: 2px 10px;
      border-radius: 999px;
      display: inline-block;
    }

    .badge-setor {
      font-size: 0.8rem;
    }

    .table-responsive {
      max-height: 420px;
      overflow-y: auto;
    }

    /* Bot√µes flutuantes (FABs) */
    .fab {
      position: fixed;
      right: 20px;
      z-index: 1050;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.3);
      border: none;
      cursor: pointer;
    }

    .fab span {
      font-size: 1.6rem;
      line-height: 1;
    }

    #fabNovo {
      bottom: 90px;
      background: linear-gradient(135deg, #198754, #20c997);
      color: #fff;
      display: none; /* vis√≠vel conforme permiss√µes */
    }

    #fabRelatorio {
      bottom: 20px;
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: #fff;
      display: none; /* vis√≠vel conforme permiss√µes */
    }

    /* Login centralizado */
    #loginContainer {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Responsividade: reduzir tamanhos no celular */
    @media (max-width: 576px) {
      body {
        font-size: 0.9rem;
      }
      .page-header h1 {
        font-size: 1.35rem;
      }
      .page-header p {
        font-size: 0.85rem;
      }
      .table {
        font-size: 0.78rem;
      }
      .badge-setor {
        font-size: 0.7rem;
      }
      .status-pendente,
      .status-resolvido,
      .status-pendente-atrasado {
        font-size: 0.75rem;
        padding: 1px 8px;
      }
      .card-body {
        padding: 0.9rem;
      }
      .fab {
        width: 52px;
        height: 52px;
        right: 16px;
      }
      #fabNovo {
        bottom: 82px;
      }
      #fabRelatorio {
        bottom: 16px;
      }
    }
  </style>
</head>
<body>

<!-- ==================== LOGIN ==================== -->
<div id="loginContainer">
  <div class="card" style="max-width: 420px; width: 100%; border-radius: 18px;">
    <div class="card-body p-4">
      <h4 class="mb-1 text-center">Acesso ao Sistema</h4>
      <p class="text-muted text-center mb-4">
        Informe seu usu√°rio e senha para registrar e acompanhar os atendimentos.
      </p>
      <form id="formLogin">
        <div class="mb-3">
          <label for="loginUsuario" class="form-label">Usu√°rio</label>
          <input type="text" id="loginUsuario" class="form-control" required />
        </div>
        <div class="mb-3">
          <label for="loginSenha" class="form-label">Senha</label>
          <div class="input-group">
            <input type="password" id="loginSenha" class="form-control" required />
            <button type="button" class="btn btn-outline-secondary" id="btnToggleSenha">
              üëÅ
            </button>
          </div>
        </div>
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="manterLogin" />
          <label class="form-check-label" for="manterLogin">
            Manter login ativo neste dispositivo
          </label>
        </div>
        <div class="mb-3">
          <small id="hintMaster" class="text-muted">
            Primeiro acesso: use<br />
            <strong>Usu√°rio:</strong> <code>master</code><br />
            <strong>Senha:</strong> <code>123</code><br />
            (o sistema cria o usu√°rio Master automaticamente na base)
          </small>
        </div>
        <button type="submit" class="btn btn-primary w-100">
          Entrar
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ==================== APLICA√á√ÉO ==================== -->
<div id="appContainer" style="display: none;">
  <div class="container py-4">
    <!-- Cabe√ßalho -->
    <div class="page-header mb-4 d-flex flex-column flex-md-row justify-content-between align-items-md-center">
      <div>
        <h1>Controle de Atendimentos - Secretaria</h1>
        <p>Registro de atendimentos de respons√°veis, acompanhamento por setor e relat√≥rios di√°rios.</p>
      </div>
      <div class="mt-3 mt-md-0 text-md-end">
        <div><strong>Usu√°rio:</strong> <span id="infoUsuarioNome"></span></div>
        <div class="small"><strong>Perfil:</strong> <span id="infoUsuarioPerfil"></span></div>
        <div class="mt-2 d-flex gap-2 justify-content-end">
          <button id="btnPerfil" class="btn btn-sm btn-outline-light">
            Meu perfil
          </button>
          <button id="btnLogout" class="btn btn-sm btn-outline-light">
            Sair
          </button>
        </div>
      </div>
    </div>

    <!-- Gest√£o de usu√°rios (apenas master/admin) -->
    <div id="gestaoUsuariosCard" class="card mb-4" style="display: none;">
      <div class="card-header bg-white border-bottom d-flex flex-column flex-lg-row justify-content-between align-items-lg-center">
        <strong>Gest√£o de usu√°rios</strong>
        <small class="text-muted">Apenas usu√°rios com permiss√£o de administra√ß√£o</small>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <!-- Form novo usu√°rio -->
          <div class="col-lg-4">
            <h6 class="mb-2">Novo usu√°rio</h6>
            <form id="formNovoUsuario">
              <div class="mb-2">
                <label for="novoUsername" class="form-label">Usu√°rio (sem espa√ßos)</label>
                <input type="text" id="novoUsername" class="form-control form-control-sm" required />
              </div>
              <div class="mb-2">
                <label for="novoSenha" class="form-label">Senha</label>
                <input type="password" id="novoSenha" class="form-control form-control-sm" required />
              </div>
              <div class="mb-2">
                <label for="novoNome" class="form-label">Nome completo</label>
                <input type="text" id="novoNome" class="form-control form-control-sm" required />
              </div>
              <div class="mb-2">
                <label for="novoPerfil" class="form-label">Perfil</label>
                <select id="novoPerfil" class="form-select form-select-sm" required>
                  <option value="Secretaria">Secretaria</option>
                  <option value="Coordena√ß√£o">Coordena√ß√£o</option>
                  <option value="Dire√ß√£o">Dire√ß√£o</option>
                  <option value="Administrador">Administrador</option>
                  <option value="Master">Master</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label">Permiss√µes</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="novoPermRegistrar" checked />
                  <label class="form-check-label" for="novoPermRegistrar">
                    Registrar atendimentos
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="novoPermStatus" checked />
                  <label class="form-check-label" for="novoPermStatus">
                    Alterar status (pendente/resolvido)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="novoPermRelatorio" checked />
                  <label class="form-check-label" for="novoPermRelatorio">
                    Gerar relat√≥rios PDF / exportar
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="novoPermGerUsuarios" />
                  <label class="form-check-label" for="novoPermGerUsuarios">
                    Gerenciar usu√°rios e setores
                  </label>
                </div>
              </div>
              <button type="submit" class="btn btn-sm btn-success mt-2">
                Criar usu√°rio
              </button>
            </form>
          </div>

          <!-- Lista de usu√°rios -->
          <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
              <h6 class="mb-0">Usu√°rios cadastrados</h6>
              <small class="text-muted">Voc√™ pode editar, desativar ou remover usu√°rios.</small>
            </div>
            <div class="table-responsive" style="max-height: 260px;">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Usu√°rio</th>
                    <th>Nome</th>
                    <th>Perfil</th>
                    <th>Ativo</th>
                    <th>Permiss√µes</th>
                    <th class="text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tbodyUsuarios">
                  <!-- via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <!-- Gest√£o de setores -->
        <div class="row g-3">
          <div class="col-lg-4">
            <h6 class="mb-2">Gest√£o de setores</h6>
            <form id="formNovoSetor">
              <div class="mb-2">
                <label for="novoSetorNome" class="form-label">Nome do setor</label>
                <input type="text" id="novoSetorNome" class="form-control form-control-sm" placeholder="Ex.: Coordena√ß√£o Fundamental II" />
              </div>
              <button type="submit" class="btn btn-sm btn-success mt-1">
                Adicionar setor
              </button>
            </form>
          </div>
          <div class="col-lg-8">
            <h6 class="mb-2">Setores cadastrados</h6>
            <div class="table-responsive" style="max-height: 220px;">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Setor</th>
                    <th>Ativo</th>
                    <th class="text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tbodySetores">
                  <!-- via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <hr class="my-4" />

        <!-- Importa√ß√£o de alunos -->
        <div class="row g-3">
          <div class="col-lg-6">
            <h6 class="mb-2">Importar lista de alunos</h6>
            <p class="text-muted small mb-2">
              Formato recomendado: arquivo <code>.json</code> com uma lista de objetos no padr√£o:<br />
              <code>[{"nome": "Aluno X", "serie": "6¬∫ ano"}, ...]</code>
            </p>
            <button id="btnImportarAlunos" class="btn btn-sm btn-outline-primary">
              Importar alunos (.json)
            </button>
            <input type="file" id="inputImportarAlunos" accept=".json" class="d-none" />
          </div>
          <div class="col-lg-6">
            <h6 class="mb-2">Alunos cadastrados (auto-completar)</h6>
            <small class="text-muted">
              Ao digitar o nome no atendimento, aparecer√£o sugest√µes com nome e s√©rie dos alunos importados.
            </small>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtro de data e a√ß√µes gerais -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <label for="dataFiltro" class="form-label fw-semibold text-secondary">
          Data do relat√≥rio / filtro
        </label>
        <input type="date" id="dataFiltro" class="form-control" />
        <div class="form-text">
          Por padr√£o, usa a data de hoje. Altere para ver outros dias.
        </div>
      </div>
      <div class="col-md-8 d-flex align-items-end gap-2 flex-wrap justify-content-md-end">
        <button id="btnExportar" class="btn btn-outline-primary">
          Exportar dados do dia (.json)
        </button>
        <button id="btnImportar" class="btn btn-outline-secondary">
          Importar dados (.json)
        </button>
        <input type="file" id="inputImportar" accept=".json" class="d-none" />
        <small class="text-muted w-100 text-md-end">
          Dados s√£o salvos em tempo real no Firebase (nuvem).
        </small>
      </div>
    </div>

    <!-- Lista de atendimentos + resumo -->
    <div class="row g-4">
      <div class="col-12">
        <!-- Lista de atendimentos -->
        <div class="card mb-3">
          <div class="card-header bg-white d-flex flex-column flex-md-row justify-content-between align-items-md-center border-bottom">
            <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
              <strong>Atendimentos do dia filtrado</strong>
              <div class="d-flex align-items-center gap-2">
                <label for="filtroSetor" class="small text-muted mb-0">Setor:</label>
                <select id="filtroSetor" class="form-select form-select-sm" style="min-width: 160px;">
                  <option value="Todos">Todos</option>
                </select>
              </div>
            </div>
            <small id="contadorAtendimentos" class="text-muted mt-2 mt-md-0"></small>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Aluno</th>
                    <th>S√©rie</th>
                    <th>Motivo</th>
                    <th>Setor</th>
                    <th>Plataforma</th>
                    <th>Retorno</th>
                    <th>Lan√ßado por</th>
                    <th>Status</th>
                    <th class="text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tbodyAtendimentos">
                  <!-- Linhas via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Resumo por setor -->
        <div class="card">
          <div class="card-header bg-white border-bottom">
            <strong>Resumo por setor (demandas do dia selecionado)</strong>
          </div>
          <div class="card-body">
            <div id="resumoSetoresVazio" class="text-muted">
              Nenhum atendimento registrado para esta data.
            </div>
            <div id="resumoSetores" class="row g-3">
              <!-- Cards de resumo via JS -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bot√£o flutuante: Novo atendimento -->
  <button
    id="fabNovo"
    class="fab"
    type="button"
    title="Novo atendimento"
  >
    <span>+</span>
  </button>

  <!-- Bot√£o flutuante: Relat√≥rio PDF -->
  <button
    id="fabRelatorio"
    class="fab"
    type="button"
    title="Gerar relat√≥rio em PDF"
  >
    <span>üìÑ</span>
  </button>

  <!-- Modal Novo Atendimento -->
  <div class="modal fade" id="modalNovoAtendimento" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Atendimento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formAtendimento">
            <input type="hidden" id="atendimentoEditandoId" />
            <div class="mb-3">
              <label for="dataAtendimentoVisivel" class="form-label">Data do atendimento</label>
              <input type="date" id="dataAtendimentoVisivel" class="form-control" />
              <input type="hidden" id="dataAtendimento" />
              <div class="form-text">Por padr√£o, usa a mesma data do filtro (pode alterar).</div>
            </div>

            <div class="mb-3">
              <label for="nomeAluno" class="form-label">Nome do aluno</label>
              <input type="text" id="nomeAluno" class="form-control" list="listaAlunos" required />
              <datalist id="listaAlunos"></datalist>
            </div>

            <div class="mb-3">
              <label for="serieAluno" class="form-label">S√©rie</label>
              <input type="text" id="serieAluno" class="form-control" placeholder="Preenchida automaticamente se o aluno estiver cadastrado" />
            </div>

            <div class="mb-3">
              <label for="motivo" class="form-label">Motivo do contato</label>
              <textarea id="motivo" class="form-control" rows="2" required></textarea>
            </div>

            <div class="mb-3">
              <label for="setor" class="form-label">Setor respons√°vel</label>
              <select id="setor" class="form-select" required>
                <option value="">Carregando setores...</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="plataforma" class="form-label">Plataforma de comunica√ß√£o com o setor</label>
              <select id="plataforma" class="form-select" required>
                <option value="">Selecione...</option>
                <option value="WhatsApp">WhatsApp</option>
                <option value="E-mail">E-mail</option>
                <option value="SMS">SMS</option>
                <option value="uTalk">uTalk</option>
                <option value="Telefone">Telefone</option>
                <option value="Presencial">Presencial</option>
                <option value="Outro">Outro</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="retorno" class="form-label">Retorno do setor</label>
              <select id="retorno" class="form-select" required>
                <option value="Sem retorno">Sem retorno</option>
                <option value="Retorno recebido">Retorno recebido</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="status" class="form-label">Situa√ß√£o</label>
              <select id="status" class="form-select" required>
                <option value="Pendente">Pendente</option>
                <option value="Resolvido">Resolvido</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="observacoes" class="form-label">Observa√ß√µes (opcional)</label>
              <textarea id="observacoes" class="form-control" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarAtendimento" class="btn btn-success">Salvar atendimento</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Observa√ß√£o ao marcar resolvido -->
  <div class="modal fade" id="modalObservacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Marcar atendimento como resolvido</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p class="mb-2">
            Voc√™ est√° marcando este atendimento como <strong>Resolvido</strong>.
          </p>
          <label for="obsResolvido" class="form-label">Observa√ß√£o (opcional)</label>
          <textarea
            id="obsResolvido"
            class="form-control"
            rows="3"
            placeholder="Ex.: Setor retornou por WhatsApp √†s 15h, combinado de enviar documento at√© amanh√£."
          ></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarObs" class="btn btn-success">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Relat√≥rio (escolher data e setor) -->
  <div class="modal fade" id="modalRelatorio" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Gerar relat√≥rio em PDF</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="relData" class="form-label">Data dos atendimentos</label>
            <input type="date" id="relData" class="form-control" />
          </div>
          <div class="mb-3">
            <label for="relSetor" class="form-label">Setor</label>
            <select id="relSetor" class="form-select">
              <option value="Todos">Todos</option>
            </select>
          </div>
          <small class="text-muted">
            O relat√≥rio ser√° gerado para a data e setor selecionados. Se escolher "Todos", ser√£o inclusos todos os setores.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnGerarRelatorioConfirm" class="btn btn-danger">Gerar PDF</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Perfil (alterar senha) -->
  <div class="modal fade" id="modalPerfil" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Meu perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formPerfil">
            <div class="mb-3">
              <label class="form-label">Usu√°rio</label>
              <input type="text" id="perfilUsername" class="form-control" disabled />
            </div>
            <div class="mb-3">
              <label for="perfilNome" class="form-label">Nome completo</label>
              <input type="text" id="perfilNome" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="perfilSenhaAtual" class="form-label">Senha atual</label>
              <input type="password" id="perfilSenhaAtual" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="perfilSenhaNova" class="form-label">Nova senha</label>
              <input type="password" id="perfilSenhaNova" class="form-control" />
            </div>
            <div class="mb-3">
              <label for="perfilSenhaConfirma" class="form-label">Confirmar nova senha</label>
              <input type="password" id="perfilSenhaConfirma" class="form-control" />
            </div>
          </form>
          <small class="text-muted">
            Deixe os campos de senha em branco se quiser alterar apenas o nome.
          </small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" id="btnSalvarPerfil" class="btn btn-primary">Salvar altera√ß√µes</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase + App (ES Module) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    doc,
    setDoc,
    getDoc,
    addDoc,
    updateDoc,
    onSnapshot,
    getDocs,
    query,
    where,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ==========================
  // CONFIGURA√á√ÉO DO SEU FIREBASE
  // ==========================
  const firebaseConfig = {
    apiKey: "AIzaSyCcOEXLRlUAE1LDqCGY4gXDzR-VrEwWxZY",
    authDomain: "atendimento-escolar.firebaseapp.com",
    projectId: "atendimento-escolar",
    storageBucket: "atendimento-escolar.firebasestorage.app",
    messagingSenderId: "528964804496",
    appId: "1:528964804496:web:4b0159e33fdf0a03ba5d15",
    measurementId: "G-N9TP4Z1Q3M"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ==========================
  // Estado global
  // ==========================
  const STORAGE_KEY_USUARIO = "atendimentos_usuario_logado";
  const STORAGE_KEY_MANTER = "atendimentos_manter_login";
  let usuarioLogado = null;
  let atendimentosDoDia = [];
  let unsubscribeAtendimentos = null;
  let unsubscribeUsuarios = null;
  let unsubscribeSetores = null;
  let unsubscribeAlunos = null;
  let atendimentoEmAlteracaoId = null;
  let setoresSeeded = false;
  let listaSetores = [];
  let listaAlunos = [];

  // =====================
  // Utilit√°rios de data
  // =====================
  function getHojeISO() {
    return new Date().toISOString().slice(0, 10); // yyyy-mm-dd
  }

  function formatarDataBR(iso) {
    if (!iso) return "";
    const [ano, mes, dia] = iso.split("-");
    return `${dia}/${mes}/${ano}`;
  }

  function getDataHoraBR() {
    const d = new Date();
    const dia = String(d.getDate()).padStart(2, "0");
    const mes = String(d.getMonth() + 1).padStart(2, "0");
    const ano = d.getFullYear();
    const hora = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    return `${dia}/${mes}/${ano} ${hora}:${min}`;
  }

  // ==========================
  // Login / Usu√°rio
  // ==========================
  async function carregarUsuarioLogadoLocal() {
    const manter = localStorage.getItem(STORAGE_KEY_MANTER) === "true";
    if (!manter) {
      localStorage.removeItem(STORAGE_KEY_USUARIO);
      return null;
    }
    const username = localStorage.getItem(STORAGE_KEY_USUARIO);
    if (!username) return null;
    try {
      const ref = doc(db, "usuarios", username);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        localStorage.removeItem(STORAGE_KEY_USUARIO);
        return null;
      }
      const data = snap.data();
      if (data.ativo === false) {
        localStorage.removeItem(STORAGE_KEY_USUARIO);
        return null;
      }
      usuarioLogado = {
        username,
        nome: data.nome,
        perfil: data.perfil,
        permissoes: data.permissoes || {}
      };
      return usuarioLogado;
    } catch (e) {
      console.error("Erro ao carregar usu√°rio logado:", e);
      return null;
    }
  }

  async function fazerLogin(username, senha) {
    const ref = doc(db, "usuarios", username);
    let snap = await getDoc(ref);

    // Se n√£o existir e for master/123, cria autom√°tico
    if (!snap.exists() && username === "master" && senha === "123") {
      const novoMaster = {
        nome: "Master",
        perfil: "Master",
        senha: "123",
        ativo: true,
        permissoes: {
          podeRegistrarAtendimento: true,
          podeAlterarStatus: true,
          podeGerarRelatorio: true,
          podeGerenciarUsuarios: true
        }
      };
      await setDoc(ref, novoMaster);
      snap = await getDoc(ref);
    }

    if (!snap.exists()) {
      return false;
    }

    const data = snap.data();
    if (data.senha !== senha) {
      return false;
    }
    if (data.ativo === false) {
      alert("Usu√°rio inativo. Procure o administrador.");
      return false;
    }

    usuarioLogado = {
      username,
      nome: data.nome,
      perfil: data.perfil,
      permissoes:
        data.permissoes || {
          podeRegistrarAtendimento: true,
          podeAlterarStatus: true,
          podeGerarRelatorio: true,
          podeGerenciarUsuarios: data.perfil === "Master"
        }
    };
    return true;
  }

  function atualizarHeaderUsuario() {
    if (!usuarioLogado) return;
    document.getElementById("infoUsuarioNome").innerText = usuarioLogado.nome;
    document.getElementById("infoUsuarioPerfil").innerText =
      usuarioLogado.perfil;
  }

  function aplicarPermissoesUI() {
    const fabNovo = document.getElementById("fabNovo");
    const fabRelatorio = document.getElementById("fabRelatorio");
    const gestaoCard = document.getElementById("gestaoUsuariosCard");

    if (!usuarioLogado) {
      fabNovo.style.display = "none";
      fabRelatorio.style.display = "none";
      gestaoCard.style.display = "none";
      return;
    }

    const perms = usuarioLogado.permissoes || {};
    fabNovo.style.display = perms.podeRegistrarAtendimento ? "flex" : "none";
    fabRelatorio.style.display = perms.podeGerarRelatorio ? "flex" : "none";
    gestaoCard.style.display = perms.podeGerenciarUsuarios ? "block" : "none";
  }

  function exibirApp() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("appContainer").style.display = "block";
    atualizarHeaderUsuario();
    aplicarPermissoesUI();
  }

  function exibirLogin() {
    document.getElementById("loginContainer").style.display = "flex";
    document.getElementById("appContainer").style.display = "none";
  }

  // ==========================
  // Listeners Firestore
  // ==========================
  function iniciarListenerAtendimentos(dataFiltro) {
    if (unsubscribeAtendimentos) {
      unsubscribeAtendimentos();
      unsubscribeAtendimentos = null;
    }
    const ref = collection(db, "atendimentos");
    unsubscribeAtendimentos = onSnapshot(
      ref,
      (snapshot) => {
        atendimentosDoDia = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          if (data.dataAtendimento === dataFiltro) {
            atendimentosDoDia.push({ id: docSnap.id, ...data });
          }
        });
        renderizarAtendimentos();
        renderizarResumoSetores();
      },
      (error) => {
        console.error("Erro no listener de atendimentos:", error);
      }
    );
  }

  function iniciarListenerUsuarios() {
    if (!usuarioLogado?.permissoes?.podeGerenciarUsuarios) return;

    if (unsubscribeUsuarios) {
      unsubscribeUsuarios();
      unsubscribeUsuarios = null;
    }

    const usuariosRef = collection(db, "usuarios");
    unsubscribeUsuarios = onSnapshot(
      usuariosRef,
      (snapshot) => {
        const tbody = document.getElementById("tbodyUsuarios");
        tbody.innerHTML = "";
        snapshot.forEach((docSnap) => {
          const username = docSnap.id;
          const u = docSnap.data();

          const tr = document.createElement("tr");
          tr.dataset.username = username;

          const tdUser = document.createElement("td");
          tdUser.textContent = username;
          tr.appendChild(tdUser);

          const tdNome = document.createElement("td");
          tdNome.innerHTML = `<input type="text" class="form-control form-control-sm" id="nome-${username}" value="${
            u.nome || ""
          }">`;
          tr.appendChild(tdNome);

          const tdPerfil = document.createElement("td");
          const perfis = [
            "Secretaria",
            "Coordena√ß√£o",
            "Dire√ß√£o",
            "Administrador",
            "Master",
            "Outro"
          ];
          let optionsHtml = "";
          perfis.forEach((p) => {
            const sel = u.perfil === p ? "selected" : "";
            optionsHtml += `<option value="${p}" ${sel}>${p}</option>`;
          });
          tdPerfil.innerHTML = `<select class="form-select form-select-sm" id="perfil-${username}">${optionsHtml}</select>`;
          tr.appendChild(tdPerfil);

          const tdAtivo = document.createElement("td");
          tdAtivo.className = "text-center";
          const ativoChecked = u.ativo === false ? "" : "checked";
          tdAtivo.innerHTML = `<input type="checkbox" class="form-check-input" id="ativo-${username}" ${ativoChecked}>`;
          tr.appendChild(tdAtivo);

          const tdPerms = document.createElement("td");
          const perms = u.permissoes || {};
          tdPerms.innerHTML = `
            <div class="d-flex flex-column gap-1 small">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="permReg-${username}" ${
            perms.podeRegistrarAtendimento ? "checked" : ""
          }>
                <label class="form-check-label" for="permReg-${username}">Registrar</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="permStatus-${username}" ${
            perms.podeAlterarStatus ? "checked" : ""
          }>
                <label class="form-check-label" for="permStatus-${username}">Status</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="permRel-${username}" ${
            perms.podeGerarRelatorio ? "checked" : ""
          }>
                <label class="form-check-label" for="permRel-${username}">Relat√≥rio</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="permUsuarios-${username}" ${
            perms.podeGerenciarUsuarios ? "checked" : ""
          }>
                <label class="form-check-label" for="permUsuarios-${username}">Usu√°rios/Setores</label>
              </div>
            </div>
          `;
          tr.appendChild(tdPerms);

          const tdAcoes = document.createElement("td");
          tdAcoes.className = "text-center d-flex gap-1 justify-content-center";
          tdAcoes.innerHTML = `
            <button class="btn btn-sm btn-outline-primary" data-username="${username}" data-action="salvar">Salvar</button>
            <button class="btn btn-sm btn-outline-danger" data-username="${username}" data-action="excluir">Excluir</button>
          `;
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });
      },
      (error) => {
        console.error("Erro no listener de usu√°rios:", error);
      }
    );
  }

  function iniciarListenerSetores() {
    if (unsubscribeSetores) {
      unsubscribeSetores();
      unsubscribeSetores = null;
    }
    const setoresRef = collection(db, "setores");
    unsubscribeSetores = onSnapshot(
      setoresRef,
      (snapshot) => {
        if (snapshot.empty && !setoresSeeded) {
          setoresSeeded = true;
          // Seed inicial de setores padr√£o
          (async () => {
            const defaultSetores = [
              "Secretaria",
              "Coordena√ß√£o",
              "Dire√ß√£o",
              "Pedag√≥gico",
              "Financeiro",
              "Orienta√ß√£o",
              "Outro"
            ];
            for (const nome of defaultSetores) {
              await addDoc(setoresRef, { nome, ativo: true });
            }
          })();
          return;
        }

        listaSetores = [];
        const tbody = document.getElementById("tbodySetores");
        tbody.innerHTML = "";

        snapshot.forEach((docSnap) => {
          const id = docSnap.id;
          const s = docSnap.data();
          listaSetores.push({ id, ...s });

          const tr = document.createElement("tr");
          tr.dataset.id = id;

          const tdNome = document.createElement("td");
          tdNome.innerHTML = `<input type="text" class="form-control form-control-sm" id="setorNome-${id}" value="${
            s.nome || ""
          }">`;
          tr.appendChild(tdNome);

          const tdAtivo = document.createElement("td");
          tdAtivo.className = "text-center";
          const ativoChecked = s.ativo === false ? "" : "checked";
          tdAtivo.innerHTML = `<input type="checkbox" class="form-check-input" id="setorAtivo-${id}" ${ativoChecked}>`;
          tr.appendChild(tdAtivo);

          const tdAcoes = document.createElement("td");
          tdAcoes.className = "text-center d-flex justify-content-center gap-1";
          tdAcoes.innerHTML = `
            <button class="btn btn-sm btn-outline-primary" data-setor-id="${id}" data-action="salvar">Salvar</button>
            <button class="btn btn-sm btn-outline-danger" data-setor-id="${id}" data-action="excluir">Excluir</button>
          `;
          tr.appendChild(tdAcoes);

          tbody.appendChild(tr);
        });

        atualizarSelectsSetores();
      },
      (error) => {
        console.error("Erro no listener de setores:", error);
      }
    );
  }

  function iniciarListenerAlunos() {
    if (unsubscribeAlunos) {
      unsubscribeAlunos();
      unsubscribeAlunos = null;
    }
    const alunosRef = collection(db, "alunos");
    unsubscribeAlunos = onSnapshot(
      alunosRef,
      (snapshot) => {
        listaAlunos = [];
        snapshot.forEach((docSnap) => {
          listaAlunos.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderizarDatalistAlunos();
      },
      (error) => {
        console.error("Erro no listener de alunos:", error);
      }
    );
  }

  function atualizarSelectsSetores() {
    const setorSelect = document.getElementById("setor");
    const filtroSetor = document.getElementById("filtroSetor");
    const relSetor = document.getElementById("relSetor");

    const setoresAtivos = listaSetores.filter((s) => s.ativo !== false);

    // Select do modal de atendimento
    setorSelect.innerHTML = "";
    if (setoresAtivos.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Sem setores cadastrados";
      setorSelect.appendChild(opt);
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Selecione...";
      setorSelect.appendChild(opt);
      setoresAtivos.forEach((s) => {
        const o = document.createElement("option");
        o.value = s.nome;
        o.textContent = s.nome;
        setorSelect.appendChild(o);
      });
    }

    // Filtro de setor na lista
    filtroSetor.innerHTML = "";
    const optTodos = document.createElement("option");
    optTodos.value = "Todos";
    optTodos.textContent = "Todos";
    filtroSetor.appendChild(optTodos);
    setoresAtivos.forEach((s) => {
      const o = document.createElement("option");
      o.value = s.nome;
      o.textContent = s.nome;
      filtroSetor.appendChild(o);
    });

    // Filtro de setor no relat√≥rio
    relSetor.innerHTML = "";
    const optTodos2 = document.createElement("option");
    optTodos2.value = "Todos";
    optTodos2.textContent = "Todos";
    relSetor.appendChild(optTodos2);
    setoresAtivos.forEach((s) => {
      const o = document.createElement("option");
      o.value = s.nome;
      o.textContent = s.nome;
      relSetor.appendChild(o);
    });
  }

  function renderizarDatalistAlunos() {
    const dl = document.getElementById("listaAlunos");
    dl.innerHTML = "";
    listaAlunos.forEach((al) => {
      const opt = document.createElement("option");
      opt.value = al.nome;
      opt.label = `${al.nome} - ${al.serie || ""}`;
      dl.appendChild(opt);
    });
  }

  // ==========================
  // Renderiza√ß√£o Atendimentos
  // ==========================
  function renderizarAtendimentos() {
    const tbody = document.getElementById("tbodyAtendimentos");
    tbody.innerHTML = "";

    const dataFiltro = document.getElementById("dataFiltro").value;
    const filtroSetor = document.getElementById("filtroSetor").value || "Todos";
    const hojeISO = getHojeISO();

    const filtrados = atendimentosDoDia.filter((a) =>
      filtroSetor === "Todos" ? true : a.setor === filtroSetor
    );

    document.getElementById("contadorAtendimentos").innerText =
      filtrados.length > 0
        ? `${filtrados.length} atendimento(s) para ${formatarDataBR(
            dataFiltro
          )}`
        : `Nenhum atendimento para ${formatarDataBR(dataFiltro)}`;

    const podeAlterar =
      usuarioLogado?.permissoes?.podeAlterarStatus === true;

    filtrados.forEach((a) => {
      const tr = document.createElement("tr");

      const isAtrasado =
        a.status === "Pendente" && a.dataAtendimento < hojeISO;

      if (isAtrasado) {
        tr.classList.add("table-danger");
      }

      const tdData = document.createElement("td");
      tdData.textContent = formatarDataBR(a.dataAtendimento);
      tr.appendChild(tdData);

      const tdAluno = document.createElement("td");
      tdAluno.textContent = a.nomeAluno;
      tr.appendChild(tdAluno);

      const tdSerie = document.createElement("td");
      tdSerie.textContent = a.serieAluno || "";
      tr.appendChild(tdSerie);

      const tdMotivo = document.createElement("td");
      tdMotivo.textContent = a.motivo;
      tr.appendChild(tdMotivo);

      const tdSetor = document.createElement("td");
      tdSetor.innerHTML = `<span class="badge bg-info text-dark badge-setor">${a.setor}</span>`;
      tr.appendChild(tdSetor);

      const tdPlataforma = document.createElement("td");
      tdPlataforma.textContent = a.plataforma;
      tr.appendChild(tdPlataforma);

      const tdRetorno = document.createElement("td");
      tdRetorno.textContent = a.retorno;
      tr.appendChild(tdRetorno);

      const tdUsuario = document.createElement("td");
      tdUsuario.textContent = a.usuarioNome || "-";
      tr.appendChild(tdUsuario);

      const tdStatus = document.createElement("td");
      const spanStatus = document.createElement("span");
      spanStatus.textContent = a.status;
      if (isAtrasado) {
        spanStatus.classList.add("status-pendente-atrasado");
      } else {
        spanStatus.classList.add(
          a.status === "Resolvido" ? "status-resolvido" : "status-pendente"
        );
      }
      tdStatus.appendChild(spanStatus);
      tr.appendChild(tdStatus);

      const tdAcoes = document.createElement("td");
      tdAcoes.className = "text-center";

      const btnGroup = document.createElement("div");
      btnGroup.className = "btn-group btn-group-sm";

      const btnEditar = document.createElement("button");
      btnEditar.className = "btn btn-outline-primary";
      btnEditar.textContent = "Editar";
      btnEditar.onclick = () => abrirEdicaoAtendimento(a.id);

      const btnToggle = document.createElement("button");
      btnToggle.className =
        "btn " +
        (a.status === "Resolvido"
          ? "btn-outline-secondary"
          : "btn-outline-success");
      btnToggle.textContent =
        a.status === "Resolvido" ? "Pendente" : "Resolvido";

      if (!podeAlterar) {
        btnToggle.disabled = true;
        btnToggle.classList.add("disabled");
      }

      btnToggle.onclick = async () => {
        if (!podeAlterar) return;

        const ref = doc(db, "atendimentos", a.id);
        if (a.status === "Resolvido") {
          await updateDoc(ref, { status: "Pendente" });
        } else {
          atendimentoEmAlteracaoId = a.id;
          document.getElementById("obsResolvido").value = "";
          const modalObs = new bootstrap.Modal(
            document.getElementById("modalObservacao")
          );
          modalObs.show();
        }
      };

      const btnExcluir = document.createElement("button");
      btnExcluir.className = "btn btn-outline-danger";
      btnExcluir.textContent = "Excluir";
      btnExcluir.onclick = async () => {
        if (
          !confirm(
            "Tem certeza que deseja excluir este atendimento? Essa a√ß√£o n√£o pode ser desfeita."
          )
        )
          return;
        await deleteDoc(doc(db, "atendimentos", a.id));
      };

      btnGroup.appendChild(btnEditar);
      btnGroup.appendChild(btnToggle);
      btnGroup.appendChild(btnExcluir);
      tdAcoes.appendChild(btnGroup);
      tr.appendChild(tdAcoes);

      tbody.appendChild(tr);
    });
  }

  // ==========================
  // Resumo por setor
  // ==========================
  function renderizarResumoSetores() {
    const container = document.getElementById("resumoSetores");
    const msgVazio = document.getElementById("resumoSetoresVazio");
    const filtroSetor = document.getElementById("filtroSetor").value || "Todos";

    container.innerHTML = "";

    const listaBase =
      filtroSetor === "Todos"
        ? atendimentosDoDia
        : atendimentosDoDia.filter((a) => a.setor === filtroSetor);

    if (listaBase.length === 0) {
      msgVazio.style.display = "block";
      return;
    }

    msgVazio.style.display = "none";

    const contagem = {};
    listaBase.forEach((a) => {
      if (!contagem[a.setor]) contagem[a.setor] = 0;
      contagem[a.setor]++;
    });

    Object.keys(contagem).forEach((setor) => {
      const col = document.createElement("div");
      col.className = "col-md-4 col-sm-6";

      const card = document.createElement("div");
      card.className = "border rounded p-3 h-100 bg-light";

      const titulo = document.createElement("div");
      titulo.className = "fw-semibold mb-1";
      titulo.textContent = setor;

      const qtd = document.createElement("div");
      qtd.innerHTML = `<span class="h3 mb-0">${contagem[setor]}</span> demanda(s)`;

      card.appendChild(titulo);
      card.appendChild(qtd);
      col.appendChild(card);
      container.appendChild(col);
    });
  }

  // ==========================
  // Editar atendimento
  // ==========================
  function abrirEdicaoAtendimento(id) {
    const a = atendimentosDoDia.find((x) => x.id === id);
    if (!a) return;
    const modalNovoEl = document.getElementById("modalNovoAtendimento");
    const modalNovo = new bootstrap.Modal(modalNovoEl);

    document.getElementById("atendimentoEditandoId").value = a.id;
    document.getElementById("dataAtendimentoVisivel").value =
      a.dataAtendimento || getHojeISO();
    document.getElementById("dataAtendimento").value =
      a.dataAtendimento || getHojeISO();
    document.getElementById("nomeAluno").value = a.nomeAluno || "";
    document.getElementById("serieAluno").value = a.serieAluno || "";
    document.getElementById("motivo").value = a.motivo || "";
    document.getElementById("setor").value = a.setor || "";
    document.getElementById("plataforma").value = a.plataforma || "";
    document.getElementById("retorno").value = a.retorno || "Sem retorno";
    document.getElementById("status").value = a.status || "Pendente";
    document.getElementById("observacoes").value = a.observacoes || "";

    modalNovo.show();
  }

  // ==========================
  // Gera√ß√£o de PDF (por data e setor)
  // ==========================
  async function gerarPDF(dataISO, setorFiltro) {
    if (!window.jspdf) {
      alert("Biblioteca jsPDF n√£o carregada.");
      return;
    }
    if (!dataISO) {
      alert("Selecione uma data para o relat√≥rio.");
      return;
    }

    const ref = collection(db, "atendimentos");
    let q;
    if (setorFiltro && setorFiltro !== "Todos") {
      q = query(
        ref,
        where("dataAtendimento", "==", dataISO),
        where("setor", "==", setorFiltro)
      );
    } else {
      q = query(ref, where("dataAtendimento", "==", dataISO));
    }

    const snap = await getDocs(q);
    const registros = [];
    snap.forEach((docSnap) => registros.push({ id: docSnap.id, ...docSnap.data() }));

    if (registros.length === 0) {
      alert("N√£o h√° atendimentos para esta data e setor.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const docPdf = new jsPDF("p", "pt", "a4");

    const dataBR = formatarDataBR(dataISO);

    docPdf.setFontSize(16);
    docPdf.text("Relat√≥rio de Atendimentos - Secretaria", 40, 40);
    docPdf.setFontSize(12);
    docPdf.text(`Data dos atendimentos: ${dataBR}`, 40, 60);
    if (setorFiltro && setorFiltro !== "Todos") {
      docPdf.text(`Setor: ${setorFiltro}`, 40, 75);
    } else {
      docPdf.text("Setor: Todos", 40, 75);
    }
    docPdf.text(`Relat√≥rio gerado em: ${getDataHoraBR()}`, 40, 90);
    if (usuarioLogado) {
      docPdf.text(
        `Gerado por: ${usuarioLogado.nome} (${usuarioLogado.perfil})`,
        40,
        105
      );
    }

    const body = registros.map((a) => [
      formatarDataBR(a.dataAtendimento),
      a.nomeAluno,
      a.serieAluno || "",
      a.motivo,
      a.setor,
      a.plataforma,
      a.retorno,
      a.usuarioNome || "",
      a.status,
      a.observacoes || ""
    ]);

    docPdf.autoTable({
      startY: 125,
      head: [
        [
          "Data",
          "Aluno",
          "S√©rie",
          "Motivo",
          "Setor",
          "Plataforma",
          "Retorno",
          "Usu√°rio",
          "Status",
          "Obs."
        ]
      ],
      body: body,
      styles: { fontSize: 8, cellPadding: 4 },
      headStyles: { fillColor: [41, 128, 185] }
    });

    const contagem = {};
    registros.forEach((a) => {
      if (!contagem[a.setor]) contagem[a.setor] = 0;
      contagem[a.setor]++;
    });

    let finalY = docPdf.lastAutoTable.finalY || 125;
    finalY += 30;

    docPdf.setFontSize(13);
    docPdf.text("Resumo de demandas por setor", 40, finalY);
    finalY += 10;

    const resumoBody = Object.keys(contagem).map((setor) => [
      setor,
      contagem[setor]
    ]);

    docPdf.autoTable({
      startY: finalY,
      head: [["Setor", "Quantidade de atendimentos"]],
      body: resumoBody,
      styles: { fontSize: 10, cellPadding: 4 },
      headStyles: { fillColor: [39, 174, 96] }
    });

    const nomeArquivo = `relatorio_atendimentos_${dataISO}${
      setorFiltro && setorFiltro !== "Todos" ? "_" + setorFiltro : ""
    }.pdf`;
    docPdf.save(nomeArquivo);
  }

  // ==========================
  // Exportar / Importar JSON
  // ==========================
  function exportarDadosDoDia() {
    if (atendimentosDoDia.length === 0) {
      alert("N√£o h√° dados para exportar nesta data.");
      return;
    }
    const dataFiltro = document.getElementById("dataFiltro").value;
    const blob = new Blob([JSON.stringify(atendimentosDoDia, null, 2)], {
      type: "application/json"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `atendimentos_${dataFiltro}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  async function importarDados(arquivo) {
    const leitor = new FileReader();
    leitor.onload = async function (e) {
      try {
        const dados = JSON.parse(e.target.result);
        if (!Array.isArray(dados)) {
          alert("Arquivo inv√°lido. Deve ser um array de atendimentos.");
          return;
        }
        const ref = collection(db, "atendimentos");
        for (const reg of dados) {
          const { id, ...resto } = reg;
          await addDoc(ref, resto);
        }
        alert("Dados importados com sucesso para o Firebase.");
      } catch (err) {
        console.error(err);
        alert("Erro ao ler o arquivo. Verifique se √© um JSON v√°lido.");
      }
    };
    leitor.readAsText(arquivo, "utf-8");
  }

  async function importarAlunos(arquivo) {
    const leitor = new FileReader();
    leitor.onload = async function (e) {
      try {
        const dados = JSON.parse(e.target.result);
        if (!Array.isArray(dados)) {
          alert("Arquivo inv√°lido. Deve ser um array de alunos.");
          return;
        }
        const ref = collection(db, "alunos");
        for (const al of dados) {
          if (!al.nome) continue;
          await addDoc(ref, {
            nome: al.nome,
            serie: al.serie || ""
          });
        }
        alert("Alunos importados com sucesso.");
      } catch (err) {
        console.error(err);
        alert("Erro ao importar alunos. Verifique se o JSON est√° no formato correto.");
      }
    };
    leitor.readAsText(arquivo, "utf-8");
  }

  // ==========================
  // Inicializa√ß√£o
  // ==========================
  document.addEventListener("DOMContentLoaded", async () => {
    const campoDataFiltro = document.getElementById("dataFiltro");
    const campoDataAtendimento = document.getElementById("dataAtendimento");
    const campoDataAtendimentoVisivel = document.getElementById(
      "dataAtendimentoVisivel"
    );
    const hoje = getHojeISO();
    campoDataFiltro.value = hoje;
    campoDataAtendimento.value = hoje;
    campoDataAtendimentoVisivel.value = hoje;

    // Mostrar/ocultar senha no login
    document
      .getElementById("btnToggleSenha")
      .addEventListener("click", () => {
        const input = document.getElementById("loginSenha");
        const isPass = input.type === "password";
        input.type = isPass ? "text" : "password";
      });

    // Sincronizar data vis√≠vel e oculta no modal
    campoDataAtendimentoVisivel.addEventListener("change", () => {
      campoDataAtendimento.value =
        campoDataAtendimentoVisivel.value || getHojeISO();
    });

    // Ocultar dica do master se ele j√° existir
    try {
      const masterSnap = await getDoc(doc(db, "usuarios", "master"));
      if (masterSnap.exists()) {
        const hint = document.getElementById("hintMaster");
        if (hint) hint.style.display = "none";
      }
    } catch (e) {
      console.error("Erro ao verificar usu√°rio master:", e);
    }

    // Tentativa de restaurar usu√°rio logado (manter login)
    await carregarUsuarioLogadoLocal();

    if (usuarioLogado) {
      exibirApp();
      iniciarListenerAtendimentos(campoDataFiltro.value);
      iniciarListenerSetores();
      iniciarListenerAlunos();
      if (usuarioLogado.permissoes?.podeGerenciarUsuarios) {
        iniciarListenerUsuarios();
      }
    } else {
      exibirLogin();
    }

    // LOGIN
    document
      .getElementById("formLogin")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        const username = document
          .getElementById("loginUsuario")
          .value.trim();
        const senha = document.getElementById("loginSenha").value;
        const manter = document.getElementById("manterLogin").checked;

        const ok = await fazerLogin(username, senha);
        if (!ok) {
          alert("Usu√°rio ou senha inv√°lidos.");
          return;
        }

        localStorage.setItem(STORAGE_KEY_MANTER, manter ? "true" : "false");
        if (manter) {
          localStorage.setItem(STORAGE_KEY_USUARIO, usuarioLogado.username);
        } else {
          localStorage.removeItem(STORAGE_KEY_USUARIO);
        }

        document.getElementById("loginUsuario").value = "";
        document.getElementById("loginSenha").value = "";
        exibirApp();
        iniciarListenerAtendimentos(campoDataFiltro.value);
        iniciarListenerSetores();
        iniciarListenerAlunos();
        if (usuarioLogado.permissoes?.podeGerenciarUsuarios) {
          iniciarListenerUsuarios();
        }
      });

    // LOGOUT
    document.getElementById("btnLogout").addEventListener("click", () => {
      usuarioLogado = null;
      localStorage.removeItem(STORAGE_KEY_USUARIO);
      localStorage.setItem(STORAGE_KEY_MANTER, "false");
      if (unsubscribeAtendimentos) unsubscribeAtendimentos();
      if (unsubscribeUsuarios) unsubscribeUsuarios();
      if (unsubscribeSetores) unsubscribeSetores();
      if (unsubscribeAlunos) unsubscribeAlunos();
      atendimentosDoDia = [];
      document.getElementById("tbodyAtendimentos").innerHTML = "";
      document.getElementById("resumoSetores").innerHTML = "";
      document.getElementById("resumoSetoresVazio").style.display = "block";
      exibirLogin();
    });

    // Altera√ß√£o da data de filtro
    campoDataFiltro.addEventListener("change", () => {
      campoDataAtendimento.value = campoDataFiltro.value || getHojeISO();
      campoDataAtendimentoVisivel.value =
        campoDataFiltro.value || getHojeISO();
      if (usuarioLogado) {
        iniciarListenerAtendimentos(campoDataFiltro.value);
      }
    });

    // Filtro por setor
    document
      .getElementById("filtroSetor")
      .addEventListener("change", () => {
        renderizarAtendimentos();
        renderizarResumoSetores();
      });

    // MODAL novo atendimento
    const modalNovoEl = document.getElementById("modalNovoAtendimento");
    const modalNovo = new bootstrap.Modal(modalNovoEl);

    // FAB Novo atendimento
    document.getElementById("fabNovo").addEventListener("click", () => {
      if (!usuarioLogado?.permissoes?.podeRegistrarAtendimento) {
        alert("Voc√™ n√£o tem permiss√£o para registrar atendimentos.");
        return;
      }
      campoDataAtendimento.value = campoDataFiltro.value || getHojeISO();
      campoDataAtendimentoVisivel.value =
        campoDataFiltro.value || getHojeISO();
      document.getElementById("formAtendimento").reset();
      document.getElementById("atendimentoEditandoId").value = "";
      modalNovo.show();
    });

    // Auto-preencher s√©rie ao escolher aluno
    document.getElementById("nomeAluno").addEventListener("change", () => {
      const nome = document.getElementById("nomeAluno").value.trim();
      const aluno = listaAlunos.find((a) => a.nome === nome);
      document.getElementById("serieAluno").value = aluno?.serie || "";
    });

    // Salvar novo/editar atendimento
    document
      .getElementById("btnSalvarAtendimento")
      .addEventListener("click", async () => {
        if (!usuarioLogado?.permissoes?.podeRegistrarAtendimento) {
          alert("Voc√™ n√£o tem permiss√£o para registrar atendimentos.");
          return;
        }

        const idEdicao = document.getElementById(
          "atendimentoEditandoId"
        ).value;
        const nomeAluno = document
          .getElementById("nomeAluno")
          .value.trim();
        const serieAluno = document
          .getElementById("serieAluno")
          .value.trim();
        const motivo = document.getElementById("motivo").value.trim();
        const setor = document.getElementById("setor").value;
        const plataforma = document.getElementById("plataforma").value;
        const retorno = document.getElementById("retorno").value;
        const status = document.getElementById("status").value;
        const observacoes = document
          .getElementById("observacoes")
          .value.trim();
        const dataAtendimento =
          campoDataAtendimento.value || getHojeISO();

        if (
          !nomeAluno ||
          !motivo ||
          !setor ||
          !plataforma ||
          !retorno ||
          !status
        ) {
          alert("Preencha todos os campos obrigat√≥rios.");
          return;
        }

        if (idEdicao) {
          const ref = doc(db, "atendimentos", idEdicao);
          await updateDoc(ref, {
            dataAtendimento,
            nomeAluno,
            serieAluno,
            motivo,
            setor,
            plataforma,
            retorno,
            status,
            observacoes
          });
        } else {
          const novo = {
            dataAtendimento,
            nomeAluno,
            serieAluno,
            motivo,
            setor,
            plataforma,
            retorno,
            status,
            observacoes,
            usuarioUsername: usuarioLogado.username,
            usuarioNome: usuarioLogado.nome
          };
          await addDoc(collection(db, "atendimentos"), novo);
        }

        document.getElementById("formAtendimento").reset();
        document.getElementById("atendimentoEditandoId").value = "";
        modalNovo.hide();
      });

    // Salvar observa√ß√£o ao marcar resolvido
    document
      .getElementById("btnSalvarObs")
      .addEventListener("click", async () => {
        const obs = document.getElementById("obsResolvido").value.trim();
        if (atendimentoEmAlteracaoId) {
          const ref = doc(db, "atendimentos", atendimentoEmAlteracaoId);
          const atual = atendimentosDoDia.find(
            (x) => x.id === atendimentoEmAlteracaoId
          );
          let novasObs = atual?.observacoes || "";
          if (obs) {
            novasObs = novasObs ? `${novasObs} | ${obs}` : obs;
          }
          await updateDoc(ref, {
            status: "Resolvido",
            observacoes: novasObs
          });
        }
        const modalObsEl = document.getElementById("modalObservacao");
        const modalObsInstance = bootstrap.Modal.getInstance(modalObsEl);
        modalObsInstance.hide();
        atendimentoEmAlteracaoId = null;
      });

    // FAB Relat√≥rio ‚Üí abre modal de filtro
    const modalRelEl = document.getElementById("modalRelatorio");
    const modalRel = new bootstrap.Modal(modalRelEl);

    document.getElementById("fabRelatorio").addEventListener("click", () => {
      if (!usuarioLogado?.permissoes?.podeGerarRelatorio) {
        alert("Voc√™ n√£o tem permiss√£o para gerar relat√≥rios.");
        return;
      }
      const dataFiltro = document.getElementById("dataFiltro").value;
      document.getElementById("relData").value = dataFiltro || getHojeISO();
      const filtroSetor = document.getElementById("filtroSetor").value;
      document.getElementById("relSetor").value =
        filtroSetor || "Todos";
      modalRel.show();
    });

    document
      .getElementById("btnGerarRelatorioConfirm")
      .addEventListener("click", async () => {
        const dataRel = document.getElementById("relData").value;
        const setorRel = document.getElementById("relSetor").value;
        await gerarPDF(dataRel, setorRel);
      });

    // Exportar / Importar atendimentos
    document
      .getElementById("btnExportar")
      .addEventListener("click", exportarDadosDoDia);

    document.getElementById("btnImportar").addEventListener("click", () => {
      document.getElementById("inputImportar").click();
    });

    document
      .getElementById("inputImportar")
      .addEventListener("change", (e) => {
        const arquivo = e.target.files[0];
        if (arquivo) {
          importarDados(arquivo);
          e.target.value = "";
        }
      });

    // Gest√£o de usu√°rios: salvar/Excluir por linha
    document
      .getElementById("tbodyUsuarios")
      .addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-username]");
        if (!btn) return;
        if (!usuarioLogado?.permissoes?.podeGerenciarUsuarios) {
          alert("Voc√™ n√£o tem permiss√£o para gerenciar usu√°rios.");
          return;
        }
        const username = btn.dataset.username;
        const action = btn.dataset.action;

        if (action === "salvar") {
          const nome = document.getElementById(`nome-${username}`).value;
          const perfil = document.getElementById(
            `perfil-${username}`
          ).value;
          const ativo = document.getElementById(
            `ativo-${username}`
          ).checked;
          const permReg = document.getElementById(
            `permReg-${username}`
          ).checked;
          const permStatus = document.getElementById(
            `permStatus-${username}`
          ).checked;
          const permRel = document.getElementById(
            `permRel-${username}`
          ).checked;
          const permUsuarios = document.getElementById(
            `permUsuarios-${username}`
          ).checked;

          const ref = doc(db, "usuarios", username);
          await updateDoc(ref, {
            nome,
            perfil,
            ativo,
            permissoes: {
              podeRegistrarAtendimento: permReg,
              podeAlterarStatus: permStatus,
              podeGerarRelatorio: permRel,
              podeGerenciarUsuarios: permUsuarios
            }
          });

          if (usuarioLogado.username === username) {
            usuarioLogado.perfil = perfil;
            usuarioLogado.permissoes = {
              podeRegistrarAtendimento: permReg,
              podeAlterarStatus: permStatus,
              podeGerarRelatorio: permRel,
              podeGerenciarUsuarios: permUsuarios
            };
            atualizarHeaderUsuario();
            aplicarPermissoesUI();
          }

          alert("Usu√°rio atualizado com sucesso.");
        } else if (action === "excluir") {
          if (username === usuarioLogado.username) {
            alert("Voc√™ n√£o pode excluir o pr√≥prio usu√°rio logado.");
            return;
          }
          if (
            !confirm(
              "Tem certeza que deseja excluir este usu√°rio? Essa a√ß√£o n√£o pode ser desfeita."
            )
          )
            return;
          await deleteDoc(doc(db, "usuarios", username));
          alert("Usu√°rio exclu√≠do com sucesso.");
        }
      });

    // Gest√£o de usu√°rios: criar novo
    document
      .getElementById("formNovoUsuario")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!usuarioLogado?.permissoes?.podeGerenciarUsuarios) {
          alert("Voc√™ n√£o tem permiss√£o para gerenciar usu√°rios.");
          return;
        }

        const username = document
          .getElementById("novoUsername")
          .value.trim();
        const senha = document.getElementById("novoSenha").value;
        const nome = document.getElementById("novoNome").value.trim();
        const perfil = document.getElementById("novoPerfil").value;
        const permReg =
          document.getElementById("novoPermRegistrar").checked;
        const permStatus =
          document.getElementById("novoPermStatus").checked;
        const permRel =
          document.getElementById("novoPermRelatorio").checked;
        const permUsuarios =
          document.getElementById("novoPermGerUsuarios").checked;

        if (!username || !senha || !nome || !perfil) {
          alert("Preencha todos os campos do novo usu√°rio.");
          return;
        }
        if (/\s/.test(username)) {
          alert("O usu√°rio n√£o pode conter espa√ßos.");
          return;
        }

        const ref = doc(db, "usuarios", username);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          alert("J√° existe um usu√°rio com esse identificador.");
          return;
        }

        const novoUsuario = {
          nome,
          perfil,
          senha,
          ativo: true,
          permissoes: {
            podeRegistrarAtendimento: permReg,
            podeAlterarStatus: permStatus,
            podeGerarRelatorio: permRel,
            podeGerenciarUsuarios: permUsuarios
          }
        };

        await setDoc(ref, novoUsuario);

        document.getElementById("formNovoUsuario").reset();
        document.getElementById("novoPermRegistrar").checked = true;
        document.getElementById("novoPermStatus").checked = true;
        document.getElementById("novoPermRelatorio").checked = true;
        document.getElementById("novoPermGerUsuarios").checked = false;
      });

    // Gest√£o de setores: salvar/excluir
    document
      .getElementById("tbodySetores")
      .addEventListener("click", async (e) => {
        const btn = e.target.closest("button[data-setor-id]");
        if (!btn) return;
        if (!usuarioLogado?.permissoes?.podeGerenciarUsuarios) {
          alert("Voc√™ n√£o tem permiss√£o para gerenciar setores.");
          return;
        }
        const id = btn.dataset.setorId;
        const action = btn.dataset.action;
        const ref = doc(db, "setores", id);

        if (action === "salvar") {
          const nome = document.getElementById(
            `setorNome-${id}`
          ).value;
          const ativo = document.getElementById(
            `setorAtivo-${id}`
          ).checked;
          await updateDoc(ref, { nome, ativo });
          alert("Setor atualizado com sucesso.");
        } else if (action === "excluir") {
          if (
            !confirm(
              "Tem certeza que deseja excluir este setor? Atendimentos antigos continuar√£o com o nome antigo."
            )
          )
            return;
          await deleteDoc(ref);
        }
      });

    // Gest√£o de setores: criar novo
    document
      .getElementById("formNovoSetor")
      .addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!usuarioLogado?.permissoes?.podeGerenciarUsuarios) {
          alert("Voc√™ n√£o tem permiss√£o para gerenciar setores.");
          return;
        }
        const nome = document
          .getElementById("novoSetorNome")
          .value.trim();
        if (!nome) {
          alert("Informe o nome do setor.");
          return;
        }
        await addDoc(collection(db, "setores"), { nome, ativo: true });
        document.getElementById("novoSetorNome").value = "";
      });

    // Importar alunos
    document
      .getElementById("btnImportarAlunos")
      .addEventListener("click", () => {
        document.getElementById("inputImportarAlunos").click();
      });

    document
      .getElementById("inputImportarAlunos")
      .addEventListener("change", (e) => {
        const arquivo = e.target.files[0];
        if (arquivo) {
          importarAlunos(arquivo);
          e.target.value = "";
        }
      });

    // Meu perfil
    const modalPerfilEl = document.getElementById("modalPerfil");
    const modalPerfil = new bootstrap.Modal(modalPerfilEl);

    document.getElementById("btnPerfil").addEventListener("click", () => {
      if (!usuarioLogado) return;
      document.getElementById("perfilUsername").value =
        usuarioLogado.username;
      document.getElementById("perfilNome").value =
        usuarioLogado.nome || "";
      document.getElementById("perfilSenhaAtual").value = "";
      document.getElementById("perfilSenhaNova").value = "";
      document.getElementById("perfilSenhaConfirma").value = "";
      modalPerfil.show();
    });

    document
      .getElementById("btnSalvarPerfil")
      .addEventListener("click", async () => {
        if (!usuarioLogado) return;
        const nomeNovo = document
          .getElementById("perfilNome")
          .value.trim();
        const senhaAtual = document.getElementById(
          "perfilSenhaAtual"
        ).value;
        const senhaNova = document.getElementById(
          "perfilSenhaNova"
        ).value;
        const senhaConf = document.getElementById(
          "perfilSenhaConfirma"
        ).value;

        if (!nomeNovo) {
          alert("Informe o nome.");
          return;
        }

        const ref = doc(db, "usuarios", usuarioLogado.username);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          alert("Usu√°rio n√£o encontrado. Fa√ßa login novamente.");
          return;
        }
        const data = snap.data();

        const updateData = { nome: nomeNovo };

        if (senhaNova || senhaConf || senhaAtual) {
          if (!senhaAtual) {
            alert("Informe a senha atual para alterar a senha.");
            return;
          }
          if (data.senha !== senhaAtual) {
            alert("Senha atual incorreta.");
            return;
          }
          if (!senhaNova || senhaNova !== senhaConf) {
            alert("Confirme corretamente a nova senha.");
            return;
          }
          updateData.senha = senhaNova;
        }

        await updateDoc(ref, updateData);
        usuarioLogado.nome = nomeNovo;
        atualizarHeaderUsuario();
        alert("Perfil atualizado com sucesso.");
        modalPerfil.hide();
      });
  });
</script>
</body>
</html>
